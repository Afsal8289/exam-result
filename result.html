<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="google-adsense-account" content="ca-pub-8490206815383590">
<title>Madrasa Exam Result</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* --- COMPACT & PREMIUM CSS --- */
:root {
  --primary: #4361ee;
  --primary-light: #e0e7ff;
  --success: #10b981;
  --danger: #ef4444;
  --info: #0ea5e9;
  --bg-color: #f0f2f5;
  --text-dark: #1e293b;
  --text-muted: #475569;
}

body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: var(--bg-color);
  color: var(--text-dark);
  font-size: 13px;
}

.container {
  max-width: 800px;
  margin: 15px auto;
  padding: 0 10px;
}

/* Card Styling */
.card {
  background: #fff;
  border-radius: 12px;
  padding: 20px 15px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
  position: relative;
  overflow: hidden;
  border: 1px solid #e2e8f0;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: linear-gradient(90deg, var(--primary), #3b82f6);
}

/* Header */
.header { text-align: center; margin-bottom: 15px; }
.header h2 { margin: 0; color: var(--primary); font-size: 20px; font-weight: 700; text-transform: uppercase; }
.header .location { color: var(--text-muted); font-size: 13px; margin-top: 3px; font-weight: 500; }
.header .badge { display: inline-block; margin-top: 8px; background: var(--primary-light); color: var(--primary); padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }

.hr { height: 1px; background: #e2e8f0; margin: 15px 0; }

/* Student Info Grid (2 Columns even on mobile) */
.info-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  background: #f8fafc;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.info-item { display: flex; align-items: center; gap: 8px; }
.info-icon {
  width: 26px; height: 26px;
  background: #fff;
  border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  color: var(--primary); font-size: 12px;
  border: 1px solid #e2e8f0;
}
.info-text span { display: block; font-size: 10px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
.info-text strong { font-size: 13px; color: var(--text-dark); word-break: break-word;}

/* Table Styling */
.table-container {
  margin-top: 15px;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #e2e8f0;
}
table { width: 100%; border-collapse: collapse; }
th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
th { background: #f8fafc; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #475569;}
td { font-weight: 600; font-size: 13px; }
tr:last-child td { border-bottom: none; }
tr:nth-child(even) { background: #fcfcfc; }

/* Status Colors */
.status-pass { color: var(--success) !important; font-weight: 700; }
.status-fail { color: var(--danger) !important; font-weight: 700; }
.status-promoted { color: var(--info) !important; font-weight: 700; }

/* Bottom Stats Grid (2x2 on mobile) */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 15px;
}
@media(min-width: 480px) {
  .stats-grid { grid-template-columns: repeat(4, 1fr); }
}

.stat-box {
  background: #fff;
  padding: 10px;
  border-radius: 8px;
  text-align: center;
  border: 1px solid #e2e8f0;
}
.stat-box span { display: block; font-size: 10px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; margin-bottom: 2px; }
.stat-box strong { font-size: 16px; color: var(--primary); }

/* Buttons */
.buttons { margin-top: 15px; display: flex; gap: 10px; flex-direction: row; }
.btn {
  flex: 1; padding: 10px; border: none; border-radius: 8px;
  font-size: 13px; font-weight: 600; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.btn-download { background: var(--primary); color: #fff; }
.btn-back { background: #fff; color: var(--text-dark); border: 1px solid #cbd5e1; }

/* Coming Soon Screen */
#comingSoonCard { text-align: center; padding: 40px 15px; }
#comingSoonCard i { font-size: 40px; color: #f59e0b; margin-bottom: 10px; }
#comingSoonCard h2 { margin: 0 0 10px; font-size: 18px; }
#comingSoonCard p { font-size: 13px; color: var(--text-muted); }

/* Loader */
#overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
  background: rgba(255,255,255,0.95); z-index: 1000; 
  display: flex; flex-direction: column; align-items: center; justify-content: center; 
}
.spinner {
  width: 30px; height: 30px; border: 3px solid var(--primary-light);
  border-top-color: var(--primary); border-radius: 50%;
  animation: spin 1s linear infinite; margin-bottom: 10px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Print/PDF specific fixes */
@media print {
  body { background: #fff; }
  .card { box-shadow: none; border: 1px solid #000; padding: 15px; border-radius: 0; }
  .buttons { display: none !important; }
  .card::before { display: none; }
}
</style>
</head>

<body>

<div id="overlay">
  <div class="spinner"></div>
  <span style="font-weight:600; color:var(--primary); font-size: 14px;">Fetching Result...</span>
</div>

<div class="container">
    
    <div class="card" id="resultCard" style="display: none;">
      <div class="header">
        <h2 id="madName">Madrasa Exam Result</h2>
        <div id="madLoc" class="location"></div> 
        <div class="badge"><i class="fas fa-award"></i> Mark Statement</div>
      </div>

      <div class="hr"></div>

      <div class="info-grid">
        <div class="info-item">
          <div class="info-icon"><i class="fas fa-user-graduate"></i></div>
          <div class="info-text"><span>Student Name</span><strong id="sName">-</strong></div>
        </div>
        <div class="info-item">
          <div class="info-icon"><i class="fas fa-id-card"></i></div>
          <div class="info-text"><span>Register No</span><strong id="sReg">-</strong></div>
        </div>
        <div class="info-item">
          <div class="info-icon"><i class="fas fa-chalkboard"></i></div>
          <div class="info-text"><span>Class</span><strong id="sClass">-</strong></div>
        </div>
        <div class="info-item">
          <div class="info-icon"><i class="fas fa-calendar-check"></i></div>
          <div class="info-text"><span>Attendance</span><strong id="sAtt">-</strong></div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Subject</th>
              <th style="text-align: center;">Marks</th>
            </tr>
          </thead>
          <tbody id="marks"></tbody>
        </table>
      </div>

      <div class="stats-grid">
        <div class="stat-box"><span>Total</span><strong id="sTotal">-</strong></div>
        <div class="stat-box"><span>Rank</span><strong id="sRank" style="color: #8b5cf6;">-</strong></div>
        <div class="stat-box"><span>Grade</span><strong id="sGrade" style="color: #ec4899;">-</strong></div>
        <div class="stat-box" style="background: #f8fafc;"><span>Status</span><strong id="sStatus">-</strong></div>
      </div>
    </div>
    
    <div class="card" id="comingSoonCard" style="display: none;">
        <i class="fas fa-lock"></i>
        <h2>Coming Soon!</h2>
        <p>റിസൾട്ട് പബ്ലിഷ് ചെയ്തിട്ടില്ല. അഡ്മിൻ റിസൾട്ട് പബ്ലിഷ് ചെയ്ത ശേഷം ദയവായി വീണ്ടും പരിശോധിക്കുക.</p>
    </div>

    <div class="buttons" id="buttonsBox" style="display: none;">
      <button class="btn btn-back" onclick="history.back()"><i class="fas fa-arrow-left"></i> Back</button>
      <button class="btn btn-download" onclick="downloadPDF()"><i class="fas fa-download"></i> Save PDF</button>
    </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyDyyTKs5JVvTScGO3vdfOJBX7DCjv-M8ZQ",
    authDomain: "madrasa-exam-result.firebaseapp.com",
    projectId: "madrasa-exam-result",
    storageBucket: "madrasa-exam-result.firebasestorage.app",
    messagingSenderId: "852087187745",
    appId: "1:852087187745:web:657b0a8ffb23b44663b660"
  });

  const db = getFirestore(app);

  const urlParams = new URLSearchParams(window.location.search);
  const mid = urlParams.get("mid");
  const cls = urlParams.get("class");
  const reg = urlParams.get("reg");

  // --- എറർ വരാതിരിക്കാനുള്ള സുരക്ഷാ കോഡുകൾ (Null Check Helpers) ---
  const setTxt = (id, text) => { let el = document.getElementById(id); if(el) el.innerText = text; };
  const setHtml = (id, html) => { let el = document.getElementById(id); if(el) el.innerHTML = html; };
  const setDisplay = (id, val) => { let el = document.getElementById(id); if(el) el.style.display = val; };
  const setClick = (id, fn) => { let el = document.getElementById(id); if(el) el.onclick = fn; };

  window.onload = () => {
      if(!cls || !reg) { setDisplay("overlay", "none"); loadClasses(); return; }
      loadResult();
  };

  async function loadClasses() {
      if(!mid) {
          if(document.body) document.body.innerHTML = "<h3 style='text-align:center; padding:50px;'>Invalid Link</h3>";
          return;
      }
      try {
          const madSnap = await getDoc(doc(db, "madrasas", mid));
          if(madSnap.exists()){
              setTxt("madName", madSnap.data().name);
              setTxt("madLoc", madSnap.data().location || "");
              if(madSnap.data().isPublished === false) {
                  setDisplay("searchBox", "none");
                  setDisplay("comingSoonCard", "block");
                  return;
              }
          }
          const q = query(collection(db, "madrasas", mid, "classes"));
          const snap = await getDocs(q);
          const sel = document.getElementById("classSelect");
          if(sel) {
              snap.forEach(d => { sel.innerHTML += `<option value="${d.id}">${d.data().name}</option>`; });
          }
      } catch (e) { console.error(e); }
  }

  setClick("searchBtn", () => {
      let c = document.getElementById("classSelect") ? document.getElementById("classSelect").value : "";
      let r = document.getElementById("regInput") ? document.getElementById("regInput").value : "";
      if(!c || !r) return alert("Select class and enter Reg No");
      window.location.href = `?mid=${mid}&class=${c}&reg=${r}`;
  });

  async function loadResult(){
      if(!mid || !cls || !reg) { alert("Invalid Result Link"); history.back(); return; }

      try {
          const madSnap = await getDoc(doc(db, "madrasas", mid));
          if(!madSnap.exists()){ alert("Invalid Madrasa ID"); history.back(); return; }
          const madData = madSnap.data();

          if(madData.expiryDate) {
              let today = new Date().toISOString().split("T")[0];
              if(today > madData.expiryDate) {
                  setDisplay("overlay", "none");
                  const soonCard = document.getElementById("comingSoonCard");
                  if(soonCard) {
                      soonCard.innerHTML = `<div class="icon-wrapper" style="background:#fee2e2;"><i class="fas fa-exclamation-triangle" style="color:#ef4444;"></i></div><h2 style="color:#ef4444;">Subscription Expired</h2><p>ഈ മദ്റസയുടെ സോഫ്റ്റ്‌വെയർ കാലാവധി കഴിഞ്ഞിരിക്കുന്നു. റിസൾട്ട് ലഭ്യമാകാൻ ദയവായി അഡ്മിനുമായി ബന്ധപ്പെടുക.</p>`;
                      setDisplay("comingSoonCard", "block");
                  }
                  setDisplay("searchBox", "none");
                  return;
              }
          }

          setTxt("madName", madData.name || "Madrasa Exam Result");
          if(madData.location) setTxt("madLoc", madData.location);
          else setDisplay("madLoc", "none");

          if(madData.isPublished === false) {
              setDisplay("overlay", "none");
              setDisplay("comingSoonCard", "block");
              return;
          }

          const classSnap = await getDoc(doc(db, "madrasas", mid, "classes", cls));
          let subjectList = [];
          if(classSnap.exists()) { subjectList = classSnap.data().subjectList || []; }

          const stuQ = query(collection(db, "madrasas", mid, "students"), where("class","==",cls), where("reg","==",reg));
          const stuSnap = await getDocs(stuQ);

          if(stuSnap.empty) {
              setDisplay("overlay", "none");
              setDisplay("notFoundCard", "block");
              return;
          }

          const studentData = stuSnap.docs[0].data();
          const marksMap = studentData.marksMap || {}; 
          
          setTxt("stuName", studentData.name);
          setTxt("stuReg", studentData.reg);
          setTxt("className", studentData.className || "Class");

          let tableHtml = "";
          let hasPassed = (studentData.resultStatus === "PASSED" || studentData.resultStatus === "PROMOTED");
          
          if(subjectList.length > 0) {
              subjectList.forEach(subName => {
                  let markVal = marksMap[subName] !== undefined ? marksMap[subName] : '-';
                  let markClass = (markVal === 'A' || markVal === 'AB' || (typeof markVal === 'number' && markVal < madData.passmark)) ? 'fail-mark' : '';
                  tableHtml += `<tr><td>${subName}</td><td class="mark-val ${markClass}">${markVal}</td></tr>`;
              });
          } else {
              Object.keys(marksMap).forEach(subName => {
                  let markVal = marksMap[subName];
                  let markClass = (markVal === 'A' || markVal === 'AB' || (typeof markVal === 'number' && markVal < madData.passmark)) ? 'fail-mark' : '';
                  tableHtml += `<tr><td>${subName}</td><td class="mark-val ${markClass}">${markVal}</td></tr>`;
              });
          }

          setHtml("marksTableBody", tableHtml);

          let totalValue = studentData.totalMarks || 0;
          setTxt("totalMarks", totalValue);
          
          let rankValue = studentData.rank || "-";
          let gradeValue = studentData.grade || "-";
          
          if(studentData.resultStatus === "PROMOTED") {
               rankValue += " (Promoted)";
               let rc = document.getElementById("rankContainer");
               if(rc) rc.classList.add("promoted-box");
          }

          setTxt("rankVal", rankValue);
          setTxt("gradeVal", gradeValue);
          setTxt("attVal", studentData.attendance || "-");

          let statusBadge = document.getElementById("statusBadge");
          if(statusBadge) {
              if(hasPassed) {
                  statusBadge.innerText = studentData.resultStatus;
                  statusBadge.className = "status-badge pass";
              } else {
                  statusBadge.innerText = "FAILED";
                  statusBadge.className = "status-badge fail";
                  setTxt("rankVal", "-");
                  setTxt("gradeVal", "D");
              }
          }

          setDisplay("overlay", "none");
          setDisplay("resultCard", "block");
          
      } catch(error) {
          console.error(error);
          alert("Error fetching result. Please try again.");
          setDisplay("overlay", "none");
      }
  }

  setClick("printBtn", () => window.print());
  setClick("backBtn", () => window.location.href = `?mid=${mid}`);
</script>